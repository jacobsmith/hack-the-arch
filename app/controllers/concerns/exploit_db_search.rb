require 'csv'
require 'open3'

class ExploitDbSearch
  HEADERS = %w(id file description date author platform type port)

  def self.exploit_database_dir
    # /root/hack-the-arch/app/controllers/concerns
    "#{this_file_dir}/../../../lib/exploit-database"
  end

  def self.search(term)
    # the Open3#capture2 call here handles most bash script execution tricks (since we're executing user input; ironic, eh?)
    std_out, status = Open3.capture2 *%W(grep -i #{term} #{exploit_database_dir}/files.csv)
    parse(std_out)
  end

  def self.load(exploit_id)
    results = self.search(exploit_id)
    info = results.find { |row| row["id"] == exploit_id }
    info["file_contents"] = File.read("#{exploit_database_dir}/#{info["file"]}")
    info
  end

  private

  def self.parse(data)
    CSV.new(data, headers: HEADERS)
  end

  def self.log(arg)
    if defined? Rails.logger
      Rails.logger.debug arg
    else
      puts arg
    end
  end

  def self.this_file_dir
    File.dirname(__FILE__)
  end
end
